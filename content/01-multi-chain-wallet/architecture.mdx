# 架构设计

这一部分我会从架构层面讲清楚一个多链钱包应用涉及哪些服务、组件，以及服务间如何调用。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (React)                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   私钥管理      │  │   交易签名      │  │   直接RPC调用   │  │
│  │   (ethers.js)   │  │   (ethers.js)   │  │   (余额查询)    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   地址派生      │  │   Faucet调用    │  │   UI组件        │  │
│  │   (BIP44)       │  │   (直接API)     │  │   (React)       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────┬───────────────────────────────────┘
                              │ HTTP API (仅元数据)
┌─────────────────────────────▼───────────────────────────────────┐
│                        后端层 (Go)                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   元数据存储    │  │   区块链查询    │  │   交易广播      │  │
│  │   (MySQL)       │  │   (RPC调用)     │  │   (RPC调用)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────┬───────────────────────────────────┘
                              │ RPC调用
┌─────────────────────────────▼───────────────────────────────────┐
│                        区块链网络层                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   以太坊RPC     │  │   Polygon RPC   │  │  Arbitrum RPC   │  │
│  │   (主网/测试网) │  │   (主网/测试网) │  │   (主网/测试网) │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────┬───────────────────────────────────┘
                              │ 本地开发
┌─────────────────────────────▼───────────────────────────────────┐
│                        本地开发环境                              │
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │   Hardhat节点   │  │   Faucet服务    │                      │
│  │   (本地测试链)  │  │   (测试币领取)  │                      │
│  └─────────────────┘  └─────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

## 核心服务组件

### 前端服务 (React) - 主要职责
**私钥和钱包管理**：
- `KeyManager` - 使用ethers.js生成和管理私钥
- `AddressService` - 地址标准化和验证
- `signing.ts` - 交易签名服务
- 使用BIP44标准派生多链地址

**直接区块链交互**：
- 使用ethers.js直接连接RPC节点
- 前端直接查询余额、Gas价格
- 前端直接签名和发送交易
- 前端直接调用Faucet API

**技术栈**：
- React + TypeScript + Redux
- ethers.js (主要区块链交互库)
- Ant Design UI组件
- IndexedDB (本地存储私钥)

### 后端服务 (Go API) - 辅助职责
**元数据管理**：
- `handlers/wallet.go` - 钱包元数据CRUD
- `handlers/transaction.go` - 交易相关API
- `pkg/wallet/` - 钱包业务逻辑
- MySQL存储钱包和账户信息

**区块链查询服务**：
- `pkg/rpc/client.go` - RPC客户端封装
- 查询余额、交易历史、Gas价格
- 广播已签名的交易
- 获取交易回执

**技术栈**：
- Go + Gin框架
- MySQL + GORM
- go-ethereum库

### 数据库服务 (MySQL)
**存储内容**：
- 钱包元数据（ID、名称、类型、创建时间）
- 账户信息（ID、地址、链ID、余额、钱包ID）
- **不存储**：私钥、助记词等敏感信息

### 区块链网络服务
**支持的链**：
- 以太坊主网/测试网
- Polygon主网/测试网  
- Arbitrum主网/测试网

**RPC功能**：
- 查询余额 (`eth_getBalance`)
- 获取Gas价格 (`eth_gasPrice`)
- 发送交易 (`eth_sendRawTransaction`)
- 查询交易历史 (遍历区块)

### 本地开发服务
**Hardhat节点**：
- 本地以太坊测试链 (端口8545)
- 支持合约部署和测试
- 提供测试ETH

**Faucet服务**：
- 独立服务 (端口8600)
- 测试币领取API
- 自动发放测试ETH给指定地址

## 服务间调用流程

### 钱包创建流程
```
用户输入助记词 → 前端验证 → 前端生成私钥 → 前端派生地址 → 前端存储私钥
     ↓
前端调用后端API → 后端存储元数据 → MySQL保存钱包信息
```

**详细步骤**：
1. 用户在前端输入助记词
2. 前端使用ethers.js验证助记词格式
3. 前端使用BIP44标准派生多链地址
4. 前端将私钥加密后存储到IndexedDB
5. 前端调用后端API保存钱包元数据（不包含私钥）
6. 后端将钱包信息存储到MySQL
7. 前端显示钱包卡片和账户列表

### 交易发送流程
```
用户填写交易 → 前端查询Gas费 → 前端签名交易 → 前端直接发送 → 区块链确认
```

**详细步骤**：
1. 用户填写接收地址和金额
2. 前端直接调用RPC查询Gas价格和余额
3. 前端使用私钥签名交易（ethers.js）
4. 前端直接调用RPC发送已签名交易
5. 前端监听交易状态和确认
6. 前端更新UI显示交易结果

### 余额查询流程
```
用户查看余额 → 前端直接RPC查询 → 前端更新UI
```

**详细步骤**：
1. 用户打开钱包界面
2. 前端从IndexedDB获取账户地址
3. 前端直接调用各链RPC查询余额
4. 前端更新UI显示余额
5. 可选：前端调用后端API更新数据库中的余额缓存

### 交易历史查询流程
```
用户查看历史 → 前端调用后端API → 后端RPC查询 → 返回历史数据
```

**详细步骤**：
1. 用户点击查看交易历史
2. 前端调用后端API获取交易历史
3. 后端查询MySQL获取账户地址
4. 后端调用RPC遍历区块查询交易
5. 后端返回交易历史给前端
6. 前端显示交易列表

### 测试币领取流程
```
用户点击领取 → 前端直接调用Faucet → Faucet调用Hardhat → 发放测试币
```

**详细步骤**：
1. 用户点击"领取测试币"按钮
2. 前端直接调用Faucet API (端口8600)
3. Faucet服务验证地址和限制
4. Faucet服务调用Hardhat节点转账
5. 返回交易哈希给前端
6. 前端刷新余额显示

## 关键技术特点

### 前端主导的架构设计
**为什么前端直接操作区块链？**
- **安全性**：私钥永远不离开用户设备，类似MetaMask
- **去中心化**：不依赖中心化服务器进行交易
- **用户体验**：交易确认更快，无需等待后端处理
- **可靠性**：即使后端服务宕机，用户仍可进行交易

### 安全性设计
- **私钥管理**：私钥和助记词只在前端处理，后端不存储敏感信息
- **加密存储**：前端使用IndexedDB加密存储私钥
- **本地签名**：所有交易在前端本地签名，私钥不传输
- **API安全**：后端API只处理元数据，不涉及私钥

### 多链支持
- **统一接口**：前端使用ethers.js统一处理所有EVM链
- **链切换**：前端可以轻松切换不同区块链RPC
- **地址派生**：使用BIP44标准派生多链地址
- **RPC管理**：后端提供RPC客户端池管理

### 开发环境
- **本地测试**：Hardhat提供本地测试链 (端口8545)
- **测试币**：Faucet服务自动发放测试币 (端口8600)
- **热重载**：前后端都支持热重载开发
- **独立服务**：各服务可独立启动和调试

## 架构优势

### 相比传统架构的优势
1. **更安全**：私钥不经过服务器，降低泄露风险
2. **更快速**：交易直接发送到区块链，减少中间环节
3. **更可靠**：前端不依赖后端服务进行核心操作
4. **更去中心化**：符合Web3的去中心化理念

### 后端的作用
- **元数据管理**：存储钱包和账户的基本信息
- **查询服务**：提供复杂的区块链查询功能
- **缓存优化**：缓存余额和交易历史，提升查询速度
- **API网关**：统一管理RPC连接和错误处理

## 总结

这个多链钱包项目采用了**前端主导**的架构设计：

**前端**：负责私钥管理、交易签名、直接区块链交互
**后端**：负责元数据存储、复杂查询、RPC管理
**数据库**：存储钱包元数据（不存储私钥）
**区块链**：提供底层的交易验证和状态存储
**本地服务**：提供开发和测试环境

通过这种架构，实现了安全、快速、去中心化的多链钱包应用。

## 下一步

要了解具体的业务流程实现，请查看 [核心流程](/01-multi-chain-wallet/core-flows) 章节，其中包含了详细的时序图和实现说明。
